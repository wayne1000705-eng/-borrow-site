<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>借用系統（用戶端＆開發端）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background: #f5f7fb; margin: 0; }
    header { background: #0a7ac3; color: #fff; padding: 16px; }
    main { max-width: 960px; margin: 24px auto; background: #fff; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); padding: 20px; }
    h2 { margin-top: 0; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { border: 1px solid #e6e9ef; border-radius: 8px; padding: 12px; }
    .row { display: flex; align-items: center; gap: 8px; }
    input, select, button { padding: 10px; border: 1px solid #cbd3df; border-radius: 6px; }
    button { background: #0a7ac3; color: #fff; border: none; cursor: pointer; }
    button.secondary { background: #59667a; }
    button.danger { background: #c34040; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .label { font-weight: bold; color: #334155; }
    .status { font-weight: bold; }
    .status.pending { color: #b7791f; }
    .status.approved { color: #2f855a; }
    .status.rejected { color: #c53030; }
    .hidden { display: none; }
    .list { list-style: none; padding: 0; margin: 0; }
    .list li { border-bottom: 1px solid #eee; padding: 8px 0; display: flex; justify-content: space-between; align-items: center; }
    .muted { color: #6b7280; font-size: 0.92em; }
  </style>
</head>
<body>
  <header>
    <div class="row" style="justify-content: space-between;">
      <div>
        <div class="label">借用系統</div>
        <div class="muted">用戶端只能借上架物品；開發端可新增物品與審核申請</div>
      </div>
      <div id="auth-area">
        <span id="user-email" class="muted"></span>
        <button id="logout-btn" class="secondary hidden">登出</button>
      </div>
    </div>
  </header>

  <main>
    <!-- 登入區 -->
    <section id="login-section">
      <h2>登入</h2>
      <div class="grid">
        <div class="card">
          <div class="row"><span class="label">電子郵件</span><input id="email" type="email" placeholder="you@example.com" /></div>
          <div class="row"><span class="label">密碼</span><input id="password" type="password" placeholder="至少 6 碼" /></div>
          <div class="row">
            <button id="login-btn">登入</button>
            <button id="signup-btn" class="secondary">註冊</button>
          </div>
          <div id="login-msg" class="muted"></div>
        </div>
        <div class="card">
          <p class="label">提示：</p>
          <ul class="list">
            <li>登入才能借東西
            <li>管理員登入後才能看到「開發端面板」。</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- 用戶端：借用區 -->
    <section id="client-section" class="hidden">
      <h2>用戶端：選擇物品借用</h2>

      <div class="card">
        <div class="row">
          <span class="label">搜尋</span>
          <input id="search" type="text" placeholder="輸入物品名稱" />
          <button id="refresh-items" class="secondary">重新載入</button>
        </div>
      </div>

      <div class="card">
        <ul id="items-list" class="list"></ul>
      </div>

      <div class="card">
        <h3>借用申請</h3>
        <div class="grid">
          <div class="row"><span class="label">選擇物品</span><select id="borrow-item"></select></div>
          <div class="row"><span class="label">日期與時間</span><input id="borrow-datetime" type="datetime-local" /></div>
        </div>
        <div class="row">
          <button id="submit-request">送出申請</button>
          <span id="request-msg" class="muted"></span>
        </div>
      </div>

      <div class="card">
        <h3>我的申請</h3>
        <ul id="my-requests" class="list"></ul>
      </div>
    </section>

    <!-- 開發端：管理面板 -->
    <section id="admin-section" class="hidden">
      <h2>開發端：物品管理與審核</h2>

      <div class="grid">
        <div class="card">
          <h3>新增物品</h3>
          <div class="row"><input id="new-item-name" type="text" placeholder="物品名稱（例如：筆電、雨傘）" /></div>
          <div class="row"><button id="add-item-btn">新增</button><span id="add-item-msg" class="muted"></span></div>
        </div>

        <div class="card">
          <h3>現有物品</h3>
          <ul id="admin-items" class="list"></ul>
        </div>
      </div>

      <div class="card">
        <h3>待審核申請</h3>
        <ul id="pending-requests" class="list"></ul>
      </div>
    </section>
  </main>

  <!-- Firebase SDK -->
  <script type="module">
    // 1) 替換成你的 Firebase 設定
const firebaseConfig = {
  apiKey: "AIzaSyBk6ano5skpGmnb3D1pNsm2TPBVBYtQtQ",
  authDomain: "borrow-site.firebaseapp.com",
  projectId: "borrow-site",
  storageBucket: "borrow-site.appspot.com",
  messagingSenderId: "1180824138068",
  appId: "1:1180824138068:web:1de04794ad05d980c25989",
  measurementId: "G-MJ2WMJ6TEW"
};

    // 2) 匯入 Firebase 套件（CDN 模組）
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc,
      collection, query, where, getDocs, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 初始化
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM
    const loginSection = document.getElementById("login-section");
    const clientSection = document.getElementById("client-section");
    const adminSection  = document.getElementById("admin-section");
    const loginBtn = document.getElementById("login-btn");
    const signupBtn = document.getElementById("signup-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const loginMsg = document.getElementById("login-msg");
    const userEmailSpan = document.getElementById("user-email");

    const itemsList = document.getElementById("items-list");
    const adminItemsList = document.getElementById("admin-items");
    const borrowItemSelect = document.getElementById("borrow-item");
    const borrowDatetimeInput = document.getElementById("borrow-datetime");
    const submitRequestBtn = document.getElementById("submit-request");
    const requestMsg = document.getElementById("request-msg");
    const myRequestsList = document.getElementById("my-requests");
    const pendingRequestsList = document.getElementById("pending-requests");
    const refreshItemsBtn = document.getElementById("refresh-items");
    const searchInput = document.getElementById("search");
    const newItemNameInput = document.getElementById("new-item-name");
    const addItemBtn = document.getElementById("add-item-btn");
    const addItemMsg = document.getElementById("add-item-msg");

    // UI 控制
    function show(section) {
      loginSection.classList.add("hidden");
      clientSection.classList.add("hidden");
      adminSection.classList.add("hidden");
      section.classList.remove("hidden");
    }

    async function getRole(uid) {
      const ref = doc(db, "roles", uid);
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data().role : "user";
    }

    // 登入／註冊／登出
    loginBtn.onclick = async () => {
      loginMsg.textContent = "";
      try {
        await signInWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value.trim());
      } catch (e) {
        loginMsg.textContent = "登入失敗：" + e.message;
      }
    };

    signupBtn.onclick = async () => {
      loginMsg.textContent = "";
      try {
        await createUserWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value.trim());
        loginMsg.textContent = "註冊成功，請通知管理者在 roles 設定你的權限（或自行將自己設為 admin）";
      } catch (e) {
        loginMsg.textContent = "註冊失敗：" + e.message;
      }
    };

    logoutBtn.onclick = async () => {
      await signOut(auth);
    };

    // 監聽登入狀態
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userEmailSpan.textContent = user.email;
        logoutBtn.classList.remove("hidden");

        const role = await getRole(user.uid);
        if (role === "admin") {
          // 顯示管理面板與用戶端
          show(clientSection);
          adminSection.classList.remove("hidden");
          initAdmin(user);
          initClient(user);
        } else {
          // 只顯示用戶端
          show(clientSection);
          initClient(user);
        }
      } else {
        userEmailSpan.textContent = "";
        logoutBtn.classList.add("hidden");
        show(loginSection);
      }
    });

    // 用戶端邏輯
    function renderItems(items) {
      itemsList.innerHTML = "";
      borrowItemSelect.innerHTML = "";
      const keyword = (searchInput.value || "").toLowerCase();

      items
        .filter(it => it.name.toLowerCase().includes(keyword))
        .forEach(it => {
          const li = document.createElement("li");
          li.innerHTML = `
            <div>
              <div class="label">${it.name}</div>
              <div class="muted">${it.available ? "可借用" : "不可借用"}</div>
            </div>
            <div>
              <button ${it.available ? "" : "disabled"} data-id="${it.id}" data-name="${it.name}">選擇</button>
            </div>
          `;
          itemsList.appendChild(li);

          if (it.available) {
            const opt = document.createElement("option");
            opt.value = it.id;
            opt.textContent = it.name;
            borrowItemSelect.appendChild(opt);
          }
        });

      // 快速選擇（點選按鈕會同步下拉選）
      itemsList.querySelectorAll("button[data-id]").forEach(btn => {
        btn.onclick = () => {
          borrowItemSelect.value = btn.dataset.id;
          borrowDatetimeInput.focus();
        };
      });
    }

    async function fetchItems(cb) {
      const q = query(collection(db, "items"));
      const snap = await getDocs(q);
      const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      cb(items);
    }

    async function initClient(user) {
      await fetchItems(renderItems);

      refreshItemsBtn.onclick = async () => {
        await fetchItems(renderItems);
      };

      searchInput.oninput = async () => {
        await fetchItems(renderItems);
      };

      submitRequestBtn.onclick = async () => {
        requestMsg.textContent = "";
        const itemId = borrowItemSelect.value;
        const datetime = borrowDatetimeInput.value;
        if (!itemId || !datetime) {
          requestMsg.textContent = "請選物品並填日期時間";
          return;
        }
        // 取得物品名稱
        const itemSnap = await getDoc(doc(db, "items", itemId));
        if (!itemSnap.exists()) {
          requestMsg.textContent = "物品不存在";
          return;
        }
        const item = itemSnap.data();

        try {
          await addDoc(collection(db, "requests"), {
            itemId,
            itemName: item.name,
            userId: user.uid,
            userEmail: user.email,
            datetime, // 可改為 Timestamp
            status: "pending",
            createdAt: new Date().toISOString()
          });
          requestMsg.textContent = "已送出申請，等待審核";
          borrowDatetimeInput.value = "";
          // 重新載入我的申請
          loadMyRequests(user);
        } catch (e) {
          requestMsg.textContent = "申請失敗：" + e.message;
        }
      };

      // 我的申請
      await loadMyRequests(user);
    }

    async function loadMyRequests(user) {
      const q = query(collection(db, "requests"), where("userId", "==", user.uid));
      const snap = await getDocs(q);
      myRequestsList.innerHTML = "";
      snap.docs.forEach(d => {
        const req = d.data();
        const li = document.createElement("li");
        li.innerHTML = `
          <div>
            <div class="label">${req.itemName}</div>
            <div class="muted">時間：${req.datetime}</div>
          </div>
          <div class="status ${req.status}">${req.status}</div>
        `;
        myRequestsList.appendChild(li);
      });
    }

    // 管理端邏輯
    async function initAdmin(user) {
      // 物品即時更新（onSnapshot）
      onSnapshot(collection(db, "items"), (snap) => {
        adminItemsList.innerHTML = "";
        snap.docs.forEach(d => {
          const it = { id: d.id, ...d.data() };
          const li = document.createElement("li");
          li.innerHTML = `
            <div>
              <div class="label">${it.name}</div>
              <div class="muted">${it.available ? "可借用" : "不可借用"}</div>
            </div>
            <div class="row">
              <button data-action="toggle" data-id="${it.id}">${it.available ? "下架" : "上架"}</button>
              <button class="danger" data-action="delete" data-id="${it.id}">刪除</button>
            </div>
          `;
          adminItemsList.appendChild(li);
        });

        adminItemsList.querySelectorAll("button").forEach(btn => {
          const id = btn.dataset.id;
          const action = btn.dataset.action;
          btn.onclick = async () => {
            if (action === "toggle") {
              const ref = doc(db, "items", id);
              const cur = await getDoc(ref);
              const available = cur.data().available;
              await updateDoc(ref, { available: !available });
            } else if (action === "delete") {
              await deleteDoc(doc(db, "items", id));
            }
          };
        });
      });

      // 新增物品
      addItemBtn.onclick = async () => {
        addItemMsg.textContent = "";
        const name = newItemNameInput.value.trim();
        if (!name) {
          addItemMsg.textContent = "請輸入物品名稱";
          return;
        }
        try {
          await addDoc(collection(db, "items"), {
            name,
            available: true,
            createdBy: user.uid,
            createdAt: new Date().toISOString()
          });
          newItemNameInput.value = "";
          addItemMsg.textContent = "新增成功";
        } catch (e) {
          addItemMsg.textContent = "新增失敗：" + e.message;
        }
      };

      // 待審核申請（即時監聽）
      onSnapshot(query(collection(db, "requests"), where("status", "==", "pending")), (snap) => {
        pendingRequestsList.innerHTML = "";
        snap.docs.forEach(d => {
          const req = { id: d.id, ...d.data() };
          const li = document.createElement("li");
          li.innerHTML = `
            <div>
              <div class="label">${req.itemName}</div>
              <div class="muted">申請人：${req.userEmail}</div>
              <div class="muted">時間：${req.datetime}</div>
            </div>
            <div class="row">
              <button data-action="approve" data-id="${req.id}" data-item="${req.itemId}">核准</button>
              <button class="danger" data-action="reject" data-id="${req.id}">拒絕</button>
            </div>
          `;
          pendingRequestsList.appendChild(li);
        });

        pendingRequestsList.querySelectorAll("button").forEach(btn => {
          btn.onclick = async () => {
            const action = btn.dataset.action;
            const reqId = btn.dataset.id;
            if (action === "approve") {
              // 1) 更新申請為 approved
              await updateDoc(doc(db, "requests", reqId), { status: "approved" });
              // 2) 將物品標記為不可借用
              const itemId = btn.dataset.item;
              await updateDoc(doc(db, "items", itemId), { available: false });
            } else if (action === "reject") {
              await updateDoc(doc(db, "requests", reqId), { status: "rejected" });
            }
          };
        });
      });
    }
  </script>
</body>
<body>
  <button id="testBtn">測試 Firebase</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBkie6n3skpcGmnbp31DpNsmZTPWBVYtQ",
      authDomain: "borrow-site.firebaseapp.com",
      projectId: "borrow-site",
      storageBucket: "borrow-site.appspot.com",
      messagingSenderId: "1108024130860",
      appId: "1:1108024130860:web:37f1237df9015c19259089"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    document.getElementById("testBtn").addEventListener("click", () => {
      alert("Firebase 已成功初始化！");
    });
  </script>
</body>
</html>
